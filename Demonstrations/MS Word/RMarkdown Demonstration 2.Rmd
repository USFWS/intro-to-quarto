---
title: "2022 Data Management Workshop: RMarkdown"
subtitle: "Knit to Word Demonstration"
author: "Jason Ross & Jacob Cochran"
date: "`r format(Sys.time(), '%B %d %Y')`"
output:
  word_document:
   reference_docx: word-styles-reference-01.docx
   toc: yes
params:
  SPECIES: 
    choices:
    - Black Crappie
    - Common Carp
    input: select
    value: Species
  YEAR: 2018
  
---

\newpage  

```{r setup, include=FALSE}
## Set the default options for all of the chunks so you do not need to duplicate
## each option in every chunk
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)

```

```{r Libraries, include=FALSE}

library(tidyverse)
library(lubridate)
library(readxl)
library(janitor)
library(kableExtra)
library(flextable)
library(rmarkdown)
library(officer)
library(knitr)

```

```{r Data Import, include=FALSE}
## Import the effort and catch tables used for the summaries in this report
Effort <- read_csv("C:/Users/jross/OneDrive - DOI/Documents/Data Management/2022 R Markdown Training/Effort_Example.csv")
Catch <- read_csv("C:/Users/jross/OneDrive - DOI/Documents/Data Management/2022 R Markdown Training/Catch_Example.csv")

```
# Introduction

This document demonstrates how to render a Word document using **RMarkdown** ([RMarkdown Cheat Sheet](https://www.rstudio.com/wp-content/uploads/2015/02/rmarkdown-cheatsheet.pdf)) and provides a few helpful links. Rendering a Word document can be challenging to format in R, especially when trying to format a table. Unlike rendering a PDF where you can format the document in the R script, it is better to format a reference document that can be used to format the document you are rendering ([Formating a Word document article](https://rmarkdown.rstudio.com/articles_docx.html)). We will step through the process to generate and use the reference document today. For more complex documents, I would recommend checking out the following packages:

Other packages that may help:

  1. [Bookdown](https://bookdown.org/)
  2. [officedown](https://ardata-fr.github.io/flextable-book/index.html)

# Tables

There are a few packages that can handle tables in word ([Comparison of Packages](https://cran.r-project.org/web/packages/gtsummary/vignettes/rmarkdown.html)) with varying capabilities.  The kable package can be used for simple tables while the huxtable package uses the flextable package.  Therefore, the flextable package is best suited for formatting a table when rendering a document to word. Here are a few links that are helpful when using the flextable package:  
  
  * Flextable Resources:
    + <https://ardata-fr.github.io/flextable-book/>
    + <https://davidgohel.github.io/flextable/reference/index.html>

## Kable Package
```{r Effort Summary Kable}

# Summarize data of effort by gear and year
EffortSum<- Effort %>%
 group_by(Year,Gear) %>%
 count() %>%
 pivot_wider(names_from = Gear, values_from = n) %>%
 as_tibble() 

## Creates a table using kable
knitr::kable(EffortSum, format="simple", align = 'lccc',caption = "Table 1. This is a nice table using kable.")

```

## Flextable Package

```{r EffortSummaryFlextable}
### Chunk Name must not have special characters or spaces
library(flextable)

## Set the defaults for flextable
set_flextable_defaults(font.size = 10, padding = 3,theme_fun = theme_booktabs)
## Tell R to use the df printer as data.frame print method for the document 
use_df_printer()

### Summarizes data to create the effort summary table
EffortFlex<- Effort %>% 
 mutate(Year=as.factor(Year)) %>% 
 group_by(Year,Gear) %>% 
 count() %>% 
 pivot_wider(names_from = Gear, values_from = n) %>% 
 rename(Electrofishing="Boat Electroshocker", Bottom_Trawl="16' Bottom Trawl (4.9 m)") %>% 
 adorn_totals(where = "col") 

## Converts dataframe to a flextable and format the table
EffortTable<- flextable(EffortFlex) %>%
 #style(i=1:2, j=~2 >=120, pr_t=fp_text_default(color="red")) %>% 
  color(~Bottom_Trawl>=121, j=2,i=, color="red") %>% #Change values in column 2(j) if values in Bottom_Trawl >121%>%  
  width(width=1.1) %>% #Each column is 1.1 inches wide
 set_caption("This is a nice table using the flextable package.", style = "Table Caption") %>%
  align(align = "center",part = "all") %>%
 bold(j=ncol(EffortFlex))

## Print flextable
EffortTable

```

# Plots

## ggplot2

Embedding a figure is more straight forward than generating tables. The same package can be used to generate figures whether you are knitting MSWord, PDF, HTML, and etc. I use ggplot2 to generate my maps and figures and the reference can be found at:  
<https://ggplot2.tidyverse.org/reference/ggplot.html>

## ggplot counts

```{r CatchSummary, fig.height=4.0, fig.width=7.0, fig.cap="Figure 1. An example of a figure that was created using ggplot."}

## Summarize data to be total number of individuals by gear and year.
catchsummary<- Effort %>% 
 right_join(Catch, by="SiteID") %>% 
 group_by(Year, Gear) %>% 
 summarise(Total=sum(Number), .groups = "keep")

## Creates and formats the plot 
Catchplot<- ggplot(catchsummary,aes(Gear, Total))+
  facet_grid(Year~., scales="free")+ geom_bar(stat="identity")+theme_classic()+
  theme(axis.title.y = element_text(face="bold", size=14),axis.text.y = element_text(size=12, colour="black"))+ 
  theme(axis.title.x = element_text(face="bold", size=14),axis.text.x = element_text(size=12, colour="black"))+
  theme(strip.background = element_rect(colour = "White", fill = "white"))+ 
  theme(strip.text = element_text(size=11, face = "bold"))+
    labs(title = "Total Number of fish by gear across years")+ 
    theme(plot.title = element_text(hjust = 0.4, size=12, face="bold"))

## Print plot
Catchplot

```

## ggplot with parameters

```{r ggplotparameters, fig.height=4.0, fig.width=7.0, fig.cap= paste("Figure 2. An example of a figure that was created using ggplot with parameters",": ", params$SPECIES," ", "during"," ", params$YEAR,".",sep="")}

## Creates a data frame to summarize catch of a species by gear  
catchsummary2<- Catch %>% 
 #filter(Common_Name=="Black Crappie") %>% ## I use this before I include parameters to ensure it works correctly
 filter(Common_Name==params$SPECIES) %>% 
 right_join(Effort, by="SiteID") %>%
 filter(Year==params$YEAR) %>%
 replace_na(list(Number=0))

## Creates and formats the plot 
Catchplot2<- ggplot(catchsummary2,aes(Gear, Number))+geom_boxplot(aes(y=Number),outlier.colour = "red")+theme_classic()+
 ylab("Mean No. Individuals per Site")+
  theme(axis.title.y = element_text(face="bold", size=14),axis.text.y = element_text(size=12, colour="black"))+ 
  theme(axis.title.x = element_text(face="bold", size=14),axis.text.x = element_text(size=12, colour="black"))+
  theme(strip.background = element_rect(colour = "White", fill = "white"))+ 
  theme(strip.text = element_text(size=11, face = "bold"))+ 
    theme(plot.title = element_text(hjust = 0.4, size=12, face="bold"))

## Print plot
Catchplot2

```


